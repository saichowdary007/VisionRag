<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vision RAG Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .glass { backdrop-filter: saturate(180%) blur(16px); background: rgba(255,255,255,0.6); }
    .scrollbar::-webkit-scrollbar { width: 8px; }
    .scrollbar::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 8px; }
  </style>
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const chatForm = document.getElementById('chat-form');
      const chatInput = document.getElementById('chat-input');
      const chatBox = document.getElementById('chat-box');
      const uploadInput = document.getElementById('upload-input');
      const uploadBtn = document.getElementById('upload-btn');
      const reindexBtn = document.getElementById('reindex-btn');
      const statusEl = document.getElementById('status');

      function appendMessage(role, content, citations=[]) {
        const wrap = document.createElement('div');
        wrap.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} my-2`;
        const bubble = document.createElement('div');
        bubble.className = `${role === 'user' ? 'bg-indigo-600 text-white' : 'bg-white text-slate-800'} shadow rounded-2xl px-4 py-3 max-w-[80%] whitespace-pre-wrap`;
        bubble.innerText = content;
        wrap.appendChild(bubble);
        chatBox.appendChild(wrap);
        if (citations && citations.length) {
          const cite = document.createElement('div');
          cite.className = 'ml-2 mr-10 text-xs text-slate-500';
          cite.innerHTML = citations.map((c, i) => `
            <div class="mt-1 p-2 rounded-lg bg-slate-50 border border-slate-200">
              <div class="font-medium text-slate-700">[${i+1}] ${c.doc_id} â€” p.${c.page}</div>
              <div class="text-slate-600 mt-1 line-clamp-3">${c.snippet.replace(/</g,'&lt;')}</div>
            </div>
          `).join('');
          chatBox.appendChild(cite);
        }
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      async function sendMessage(text) {
        appendMessage('user', text);
        const wrap = document.createElement('div');
        wrap.className = 'flex justify-start my-2';
        const bubble = document.createElement('div');
        bubble.className = 'bg-white shadow rounded-2xl px-4 py-3 max-w-[80%] whitespace-pre-wrap text-slate-800';
        bubble.textContent = '';
        wrap.appendChild(bubble);
        chatBox.appendChild(wrap);
        chatBox.scrollTop = chatBox.scrollHeight;
        try {
          const res = await fetch('/chat/stream', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: text, k: 5, rerank: true }) });
          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let citations = [];
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value, { stream: true });
            // Expect JSONL lines
            const lines = chunk.split('\n').filter(Boolean);
            for (const line of lines) {
              try {
                const obj = JSON.parse(line);
                if (obj.token) {
                  bubble.textContent += obj.token;
                } else if (obj.done) {
                  citations = obj.citations || [];
                }
              } catch (_) { /* ignore parse errors */ }
            }
            chatBox.scrollTop = chatBox.scrollHeight;
          }
          if (citations.length) {
            const cite = document.createElement('div');
            cite.className = 'ml-2 mr-10 text-xs text-slate-500';
            cite.innerHTML = citations.map((c, i) => `
              <div class="mt-1 p-2 rounded-lg bg-slate-50 border border-slate-200">
                <div class="font-medium text-slate-700">[${i+1}] ${c.doc_id} â€” p.${c.page}</div>
                <div class="text-slate-600 mt-1 line-clamp-3">${c.snippet.replace(/</g,'&lt;')}</div>
              </div>
            `).join('');
            chatBox.appendChild(cite);
          }
        } catch (e) {
          bubble.textContent = 'Error: ' + e.message;
        }
      }

      chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const text = chatInput.value.trim();
        if (!text) return;
        chatInput.value = '';
        sendMessage(text);
      });

      uploadBtn.addEventListener('click', async () => {
        const file = uploadInput.files && uploadInput.files[0];
        if (!file) { statusEl.textContent = 'Choose a PDF first.'; return; }
        const fd = new FormData();
        fd.append('file', file);
        statusEl.textContent = 'Uploadingâ€¦';
        try {
          const res = await fetch('/ingest', { method: 'POST', body: fd });
          const data = await res.json();
          statusEl.textContent = 'Uploaded. Rebuilding indexâ€¦';
          await fetch('/admin/reindex', { method: 'POST' });
          statusEl.textContent = 'Reindex started. You can continue chatting.';
        } catch (e) {
          statusEl.textContent = 'Upload failed: ' + e.message;
        }
      });

      reindexBtn.addEventListener('click', async () => {
        statusEl.textContent = 'Rebuilding indexâ€¦';
        try {
          await fetch('/admin/reindex', { method: 'POST' });
          statusEl.textContent = 'Reindex started.';
        } catch (e) {
          statusEl.textContent = 'Reindex failed: ' + e.message;
        }
      });

      // greet
      appendMessage('assistant', 'Hi! Upload PDFs and ask questions about them.');
    });
  </script>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¤–</text></svg>">
  </head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-sky-50">
  <div class="max-w-5xl mx-auto p-4 lg:p-6">
    <header class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-xl bg-indigo-600 text-white grid place-items-center text-xl shadow">R</div>
        <div>
          <div class="text-lg font-semibold text-slate-800">Vision RAG Chat</div>
          <div class="text-sm text-slate-500">Multimodal, high-performance</div>
        </div>
      </div>
      <div class="glass border border-white/60 shadow rounded-xl px-3 py-2 text-sm text-slate-600" id="status">Ready</div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <section class="lg:col-span-2 bg-white shadow rounded-2xl border border-slate-100 flex flex-col h-[70vh]">
        <div id="chat-box" class="scrollbar flex-1 overflow-y-auto p-4"></div>
        <form id="chat-form" class="p-3 border-t border-slate-100 flex gap-2">
          <input id="chat-input" type="text" placeholder="Ask about your documentsâ€¦" class="flex-1 rounded-xl border border-slate-200 px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-200" />
          <button class="bg-indigo-600 text-white px-4 py-3 rounded-xl shadow hover:brightness-110 active:scale-[0.99]">Send</button>
        </form>
      </section>

      <aside class="bg-white shadow rounded-2xl border border-slate-100 p-4 h-[70vh] flex flex-col">
        <div class="font-semibold text-slate-800 mb-2">Documents</div>
        <div class="text-sm text-slate-500 mb-3">Upload PDFs to index them for search and chat.</div>
        <input id="upload-input" type="file" accept="application/pdf" class="mb-2" />
        <div class="flex gap-2">
          <button id="upload-btn" class="flex-1 bg-slate-800 text-white px-3 py-2 rounded-lg hover:brightness-110">Upload</button>
          <button id="reindex-btn" class="flex-1 bg-slate-200 text-slate-800 px-3 py-2 rounded-lg hover:bg-slate-300">Rebuild Index</button>
        </div>
        <div class="text-xs text-slate-500 mt-3">Note: Rebuild trains/search index; can take a minute depending on corpus size.</div>
        <div class="mt-6 text-sm text-slate-600">
          <div class="font-medium mb-1">Tips</div>
          <ul class="list-disc ml-4 space-y-1">
            <li>Ask precise, technical questions.</li>
            <li>Include keywords from your docs.</li>
            <li>Use the Rebuild button after uploads.</li>
          </ul>
        </div>
      </aside>
    </div>
  </div>
</body>
</html>
